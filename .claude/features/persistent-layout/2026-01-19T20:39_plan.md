---
feature: Persistent Layout
created: 2026-01-19T20:39
status: plan-complete
based-on: 2026-01-19T20:22_research.md
---

# Implementation Plan: Persistent Layout

## Architecture Overview

### Current Architecture (Problem)

```
App.tsx Routes
├── /auth → AuthPages (no layout)
└── /songs, /setlists, etc. → ProtectedRoute
    └── (full-screen auth-loading-spinner during check)
        └── Page Component
            └── ModernLayout (navbar + sidebar)
                └── Page Content

Problem: ModernLayout dismounts/remounts on every navigation
Result: White screen flicker as navbar/sidebar rebuild
```

### New Architecture (Solution)

```
App.tsx Routes
├── /auth → AuthPages (no layout)
└── Layout Route → ProtectedLayoutRoute
    ├── IF checking → auth-loading-spinner (full screen, dark theme)
    ├── IF unauthenticated → <Navigate to="/auth" /> (before layout renders)
    └── IF authenticated → ModernLayout (persistent)
        └── <Outlet /> (content area only)
            ├── /songs → SongsPage (content only)
            ├── /setlists → SetlistsPage (content only)
            └── ... (11 protected pages)

Benefits:
- ModernLayout mounts ONCE and stays mounted
- Only content area shows loading states during navigation
- Navbar/sidebar remain visible during route transitions
- No white screen flicker
```

## Component Specifications

### ProtectedLayoutRoute Component

**Purpose:** Combines auth check + layout rendering in one component

**File:** `src/components/layout/ProtectedLayoutRoute.tsx`

**Structure:**

```tsx
import { Navigate, Outlet, useLocation } from 'react-router-dom'
import { useAuthCheck } from '../../hooks/useAuthCheck'
import { useAuth } from '../../contexts/AuthContext'
import { ModernLayout } from './ModernLayout'

export const ProtectedLayoutRoute: React.FC = () => {
  const { isAuthenticated, isChecking, failureReason } = useAuthCheck()
  const { sessionExpired } = useAuth()
  const location = useLocation()

  // Show loading spinner during auth check (full screen, dark theme)
  if (isChecking) {
    return (
      <div
        className="flex items-center justify-center min-h-screen bg-gray-900"
        data-testid="auth-loading-spinner"
      >
        <div className="flex flex-col items-center gap-4">
          <div className="w-8 h-8 border-2 border-amber-500 border-t-transparent rounded-full animate-spin" />
          <span className="text-gray-400 text-sm">Loading...</span>
        </div>
      </div>
    )
  }

  // Handle session expiration
  if (sessionExpired) {
    return <Navigate to="/auth?reason=session-expired" replace />
  }

  // Redirect BEFORE rendering layout (prevents flash)
  if (!isAuthenticated) {
    switch (failureReason) {
      case 'no-band':
        return <Navigate to="/auth?view=get-started" replace />
      case 'session-expired':
        return <Navigate to="/auth?reason=session-expired" replace />
      case 'session-invalid':
        return <Navigate to="/auth?reason=session-invalid" replace />
      case 'no-user':
      default:
        return <Navigate to="/auth" replace />
    }
  }

  // Render persistent layout with outlet for content
  return (
    <ModernLayout>
      <Outlet />
    </ModernLayout>
  )
}
```

**Key Features:**

- Reuses existing `useAuthCheck` hook (no logic duplication)
- Redirects BEFORE `ModernLayout` renders (prevents flash of navbar)
- Preserves `auth-loading-spinner` testid (E2E compatibility)
- Uses `<Outlet />` for React Router nested routes

### ContentLoadingSpinner Component

**Purpose:** Shows loading state in content area only (not full screen)

**File:** `src/components/common/ContentLoadingSpinner.tsx`

**Structure:**

```tsx
import React from 'react'

interface ContentLoadingSpinnerProps {
  isLoading: boolean
  children: React.ReactNode
}

export const ContentLoadingSpinner: React.FC<ContentLoadingSpinnerProps> = ({
  isLoading,
  children,
}) => {
  if (isLoading) {
    return (
      <div
        className="flex items-center justify-center min-h-[calc(100vh-4rem)] bg-[#0a0a0a]"
        data-testid="content-loading-spinner"
      >
        <div className="flex flex-col items-center gap-4">
          <div className="w-8 h-8 border-2 border-amber-500 border-t-transparent rounded-full animate-spin" />
          <span className="text-gray-400 text-sm">Loading...</span>
        </div>
      </div>
    )
  }

  return <>{children}</>
}
```

**Styling:**

- `bg-[#0a0a0a]` - Matches ModernLayout background
- `min-h-[calc(100vh-4rem)]` - Fills content area (accounts for mobile header)
- Amber spinner - Matches existing loading UI

## File Changes

### New Files (2)

| File                                              | Purpose                      |
| ------------------------------------------------- | ---------------------------- |
| `src/components/layout/ProtectedLayoutRoute.tsx`  | Auth check + layout wrapper  |
| `src/components/common/ContentLoadingSpinner.tsx` | Content-area loading spinner |

### Modified Files (12)

| File                                | Change                                                              |
| ----------------------------------- | ------------------------------------------------------------------- |
| `src/App.tsx`                       | Replace ProtectedRoute with ProtectedLayoutRoute, use nested routes |
| `src/pages/SongsPage.tsx`           | Remove ModernLayout, add ContentLoadingSpinner                      |
| `src/pages/SetlistsPage.tsx`        | Remove ModernLayout, add ContentLoadingSpinner                      |
| `src/pages/SetlistViewPage.tsx`     | Remove ModernLayout, add ContentLoadingSpinner                      |
| `src/pages/ShowsPage.tsx`           | Remove ModernLayout, add ContentLoadingSpinner                      |
| `src/pages/ShowViewPage.tsx`        | Remove ModernLayout, add ContentLoadingSpinner                      |
| `src/pages/PracticesPage.tsx`       | Remove ModernLayout, add ContentLoadingSpinner                      |
| `src/pages/PracticeViewPage.tsx`    | Remove ModernLayout, add ContentLoadingSpinner                      |
| `src/pages/PracticeBuilderPage.tsx` | Remove ModernLayout, add ContentLoadingSpinner                      |
| `src/pages/PracticeSessionPage.tsx` | Remove ModernLayout, add ContentLoadingSpinner                      |
| `src/pages/BandMembersPage.tsx`     | Remove ModernLayout, add ContentLoadingSpinner                      |
| `src/pages/SettingsPage.tsx`        | Remove ModernLayout, add ContentLoadingSpinner                      |

### Test Files (3)

| File                                                          | Purpose                             |
| ------------------------------------------------------------- | ----------------------------------- |
| `tests/unit/components/layout/ProtectedLayoutRoute.test.tsx`  | Unit tests for auth + layout        |
| `tests/unit/components/common/ContentLoadingSpinner.test.tsx` | Unit tests for spinner              |
| `tests/e2e/layout/persistent-layout.spec.ts`                  | E2E tests for no-flicker navigation |

## Route Structure Changes

### Before (App.tsx)

```tsx
<Routes>
  <Route path="/auth" element={<AuthPages />} />
  <Route path="/auth/callback" element={<AuthCallback />} />

  <Route
    path="/songs"
    element={
      <ProtectedRoute>
        <SongsPage />
      </ProtectedRoute>
    }
  />
  <Route
    path="/setlists"
    element={
      <ProtectedRoute>
        <SetlistsPage />
      </ProtectedRoute>
    }
  />
  {/* ... each route individually wrapped */}
</Routes>
```

### After (App.tsx)

```tsx
<Routes>
  {/* Public routes - no layout */}
  <Route path="/auth" element={<AuthPages />} />
  <Route path="/auth/callback" element={<AuthCallback />} />
  <Route path="/get-started" element={<AuthPages />} />
  <Route path="/dev/dashboard" element={<DevDashboard />} />

  {/* Protected routes - persistent layout */}
  <Route element={<ProtectedLayoutRoute />}>
    <Route path="/" element={<Navigate to="/songs" replace />} />
    <Route path="/songs" element={<SongsPage />} />
    <Route path="/setlists" element={<SetlistsPage />} />
    <Route path="/setlists/new" element={<SetlistViewPage />} />
    <Route path="/setlists/:setlistId" element={<SetlistViewPage />} />
    <Route path="/shows" element={<ShowsPage />} />
    <Route path="/shows/new" element={<ShowViewPage />} />
    <Route path="/shows/:showId" element={<ShowViewPage />} />
    <Route path="/practices" element={<PracticesPage />} />
    <Route path="/practices/new" element={<PracticeViewPage />} />
    <Route path="/practices/:practiceId" element={<PracticeViewPage />} />
    <Route
      path="/practices/:practiceId/edit"
      element={<PracticeBuilderPage />}
    />
    <Route
      path="/practices/:practiceId/session"
      element={<PracticeSessionPage />}
    />
    <Route path="/band-members" element={<BandMembersPage />} />
    <Route path="/settings" element={<SettingsPage />} />
  </Route>
</Routes>
```

**Key Differences:**

- `ProtectedLayoutRoute` has NO path (applies to all nested routes)
- Nested routes define their own paths
- ModernLayout stays mounted while navigating between nested routes
- No more individual `<ProtectedRoute>` wrappers

## Page Component Pattern

### Before

```tsx
export const SongsPage: React.FC = () => {
  const { songs, isLoading } = useSongs()

  return (
    <ModernLayout>
      <div className="...">
        {isLoading ? <Spinner /> : <SongsList songs={songs} />}
      </div>
    </ModernLayout>
  )
}
```

### After

```tsx
export const SongsPage: React.FC = () => {
  const { songs, isLoading } = useSongs()

  return (
    <ContentLoadingSpinner isLoading={isLoading}>
      <div data-testid="songs-page" className="...">
        <SongsList songs={songs} />
      </div>
    </ContentLoadingSpinner>
  )
}
```

**Changes:**

- Remove `ModernLayout` wrapper (now provided by ProtectedLayoutRoute)
- Add `ContentLoadingSpinner` wrapper with `isLoading` prop
- Add `data-testid` to page root for E2E stability
- Move loading check from conditional render to wrapper

## Testing Strategy

### Unit Tests

**ProtectedLayoutRoute.test.tsx** (4 tests)

1. Shows `auth-loading-spinner` during auth check
2. Redirects to `/auth` when no user
3. Redirects to `/auth?view=get-started` when no band
4. Renders ModernLayout + Outlet when authenticated

**ContentLoadingSpinner.test.tsx** (3 tests)

1. Shows `content-loading-spinner` when `isLoading=true`
2. Renders children when `isLoading=false`
3. Has correct styling (`bg-[#0a0a0a]`, amber spinner)

### E2E Tests

**persistent-layout.spec.ts** (5 tests)

1. No white screen flicker during navigation
2. Navbar persists when navigating between pages
3. Content area shows loading spinner (not full screen)
4. Auth redirect happens before layout renders
5. Layout stays mounted during rapid navigation

### Test Data IDs

**Preserved (must not change):**

- `auth-loading-spinner` - Used in existing E2E tests
- `sidebar-band-name` - Used in band creation tests
- `settings-link` - Used in settings page tests
- `logout-button` - Used in auth flow tests

**New:**

- `content-loading-spinner` - For content-area loading tests
- `songs-page`, `setlists-page`, etc. - For page-specific assertions

## Implementation Phases

### Phase 1: Infrastructure (Non-breaking)

- Create `ProtectedLayoutRoute` component
- Create `ContentLoadingSpinner` component
- Write unit tests for both

### Phase 2: Route Restructure (Breaking but contained)

- Update `App.tsx` to use nested routes with `ProtectedLayoutRoute`
- Keep `ProtectedRoute.tsx` temporarily (for rollback)

### Phase 3: Page Updates (Incremental)

- Update pages one at a time
- Remove ModernLayout, add ContentLoadingSpinner
- Test each page after update

### Phase 4: Testing & Cleanup

- Run full E2E suite
- Archive/remove old `ProtectedRoute.tsx`
- Update CLAUDE.md with new pattern

## Success Criteria

1. ✅ No white screen flicker during navigation
2. ✅ Navbar/sidebar remain visible during route transitions
3. ✅ Content area shows themed loading spinner
4. ✅ Auth redirects happen before layout renders
5. ✅ All existing E2E tests pass
6. ✅ New E2E tests for layout persistence pass
7. ✅ Unit tests for new components pass
