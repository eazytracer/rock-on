---
feature: persistent-layout
created: 2026-01-19T20:22
status: research-complete
---

# Research: Persistent Layout

## Feature Request Summary

Eliminate white screen flicker during page navigation by hoisting ModernLayout above ProtectedRoute. This keeps the navbar/sidebar visible during route transitions, with only the content area showing loading states.

**Goal:** Improve perceived performance and user experience by maintaining visual continuity during navigation.

## Codebase Analysis

### Current Architecture

**App.tsx** - Main application routing structure

Current flow:

```
App
├── BrowserRouter
│   ├── AuthProvider
│   │   ├── ToastProvider
│   │   │   ├── ItemSyncStatusProvider
│   │   │   │   ├── AppContent
│   │   │   │   │   ├── Suspense (fallback: LoadingSpinner)
│   │   │   │   │   │   └── Routes
│   │   │   │   │   │       ├── Route "/songs" → ProtectedRoute → SongsPage (with ModernLayout)
│   │   │   │   │   │       ├── Route "/setlists" → ProtectedRoute → SetlistsPage (with ModernLayout)
│   │   │   │   │   │       ├── Route "/shows" → ProtectedRoute → ShowsPage (with ModernLayout)
│   │   │   │   │   │       ├── Route "/practices" → ProtectedRoute → PracticesPage (with ModernLayout)
│   │   │   │   │   │       ├── Route "/band-members" → ProtectedRoute → BandMembersPage (with ModernLayout)
│   │   │   │   │   │       ├── Route "/settings" → ProtectedRoute → SettingsPage (with ModernLayout)
│   │   │   │   │   │       ├── Route "/auth" → AuthPages (NO layout)
│   │   │   │   │   │       └── Route "/dev/*" → DevDashboard (NO layout)
```

**Problem:** Each page component wraps content in ModernLayout independently. When ProtectedRoute shows loading spinner during auth check, the entire layout (navbar + sidebar + content) is replaced with a spinner screen.

### Related Components

**ModernLayout.tsx:1-66** - Main application layout shell

```typescript
interface ModernLayoutProps {
  children: React.ReactNode
  bandName?: string
  userEmail?: string
  onSignOut?: () => void
}
```

**Structure:**

- Fixed sidebar on left (desktop only, `md:block`)
- Mobile header with hamburger menu
- Mobile drawer for navigation
- Main content area (`md:ml-60 min-h-screen pt-16 md:pt-0`)
- Background: `bg-[#0a0a0a]`

**Key:** ModernLayout gets auth data from `useAuth()` context directly (lines 22-28), falling back to props if provided.

**ProtectedRoute.tsx:1-85** - Route protection with auth validation

**Current Loading State (AuthLoadingSpinner, lines 13-23):**

```tsx
const AuthLoadingSpinner: React.FC = () => (
  <div
    className="flex items-center justify-center min-h-screen bg-gray-900"
    data-testid="auth-loading-spinner"
  >
    <div className="flex flex-col items-center gap-4">
      <div className="w-8 h-8 border-2 border-amber-500 border-t-transparent rounded-full animate-spin" />
      <span className="text-gray-400 text-sm">Loading...</span>
    </div>
  </div>
)
```

**Note:** The spinner already has `bg-gray-900` (dark theme). The issue is it replaces the ENTIRE screen including navbar/sidebar.

**Auth Check Flow:**

1. `useAuthCheck()` hook validates session (1.5hr grace period)
2. Returns `{ isAuthenticated, isChecking, failureReason }`
3. While `isChecking` → shows full-screen AuthLoadingSpinner
4. On failure → redirects based on failure reason

### Affected Pages (All with ModernLayout)

**Pages that import ModernLayout:**

1. **SongsPage.tsx** - `import { ModernLayout } from '../components/layout/ModernLayout'`
2. **SetlistsPage.tsx** - Same import pattern
3. **ShowsPage.tsx** - Same import pattern
4. **PracticesPage.tsx** - Same import pattern
5. **BandMembersPage.tsx** - Same import pattern
6. **SettingsPage.tsx** - Same import pattern
7. **SetlistViewPage.tsx** - Same import pattern
8. **ShowViewPage.tsx** - Same import pattern
9. **PracticeViewPage.tsx** - Same import pattern
10. **PracticeBuilderPage.tsx** - Same import pattern
11. **PracticeSessionPage.tsx** - Same import pattern

**Pattern in all pages:**

```tsx
return <ModernLayout>{/* page content */}</ModernLayout>
```

**Pages without ModernLayout (should stay this way):**

- **AuthPages.tsx** - Standalone auth UI
- **AuthCallback.tsx** - OAuth callback handler
- **DevDashboard.tsx** - Development tools page

### Context Providers

**AuthContext.tsx** - User authentication state

Provides:

- `user` object (id, email)
- `currentBand` object
- `signOut()` function
- `syncing` state
- `realtimeManager`

**Available at App level:** AuthProvider wraps the entire app, so ModernLayout can access these contexts directly (it already does!).

## Proposed Architecture

### New Layout Hierarchy

```
App
├── BrowserRouter
│   ├── AuthProvider
│   │   ├── ToastProvider
│   │   │   ├── ItemSyncStatusProvider
│   │   │   │   ├── AppContent
│   │   │   │   │   ├── Routes
│   │   │   │   │   │   ├── Layout Route (ProtectedLayoutRoute)
│   │   │   │   │   │   │   └── ModernLayout (always rendered)
│   │   │   │   │   │   │       └── Outlet or ContentLoadingSpinner
│   │   │   │   │   │   │           ├── /songs → SongsPage (content only)
│   │   │   │   │   │   │           ├── /setlists → SetlistsPage (content only)
│   │   │   │   │   │   │           └── ... other protected routes
│   │   │   │   │   │   ├── /auth → AuthPages (NO layout)
│   │   │   │   │   │   └── /dev/* → DevDashboard (NO layout)
```

### Implementation Strategy

**Use React Router's Layout Route Pattern with Outlet:**

```tsx
// App.tsx
;<Routes>
  {/* Protected routes with persistent layout */}
  <Route element={<ProtectedLayoutRoute />}>
    <Route path="/songs" element={<SongsPage />} />
    <Route path="/setlists" element={<SetlistsPage />} />
    <Route path="/setlists/new" element={<SetlistViewPage />} />
    <Route path="/setlists/:setlistId" element={<SetlistViewPage />} />
    {/* ... other protected routes ... */}
  </Route>

  {/* Public routes - no layout */}
  <Route path="/auth" element={<AuthPages />} />
  <Route path="/auth/callback" element={<AuthCallback />} />
  <Route path="/dev/*" element={<DevDashboard />} />
</Routes>

// ProtectedLayoutRoute.tsx (new component)
const ProtectedLayoutRoute = () => {
  const { isAuthenticated, isChecking, failureReason } = useAuthCheck()
  const { sessionExpired } = useAuth()

  // Handle session expiration
  if (sessionExpired) {
    return <Navigate to="/auth?reason=session-expired" replace />
  }

  // Handle auth failures (redirects)
  if (!isChecking && !isAuthenticated) {
    // ... existing redirect logic from ProtectedRoute ...
  }

  return (
    <ModernLayout>
      {isChecking ? <ContentLoadingSpinner /> : <Outlet />}
    </ModernLayout>
  )
}
```

## Affected Files

### Files to Create

**1. src/components/layout/ProtectedLayoutRoute.tsx** (new)

- Combines ProtectedRoute auth logic + ModernLayout wrapper
- Uses React Router's `<Outlet>` for child route rendering
- Shows `<ContentLoadingSpinner>` during auth check
- Handles redirects for auth failures

**2. src/components/common/ContentLoadingSpinner.tsx** (new)

- Themed loading spinner for content area only
- Dark theme background: `bg-[#0a0a0a]` (matches ModernLayout)
- Centered within content area, not full screen
- Similar styling to existing AuthLoadingSpinner but content-scoped

### Files to Modify

**1. src/App.tsx**

- Restructure routes to use nested layout route pattern
- Wrap protected routes in `<Route element={<ProtectedLayoutRoute />}>`
- Keep auth/dev routes outside the layout wrapper
- Remove individual `<ProtectedRoute>` wrappers from each route

**2. src/components/ProtectedRoute.tsx**

- Keep for potential non-layout protected routes
- OR deprecate if all protected routes use ProtectedLayoutRoute

### Files to Update (Remove ModernLayout wrapper)

All 11 page files that currently use ModernLayout:

1. **src/pages/SongsPage.tsx** - Remove ModernLayout import and wrapper
2. **src/pages/SetlistsPage.tsx** - Same
3. **src/pages/SetlistViewPage.tsx** - Same
4. **src/pages/ShowsPage.tsx** - Same
5. **src/pages/ShowViewPage.tsx** - Same
6. **src/pages/PracticesPage.tsx** - Same
7. **src/pages/PracticeViewPage.tsx** - Same
8. **src/pages/PracticeBuilderPage.tsx** - Same
9. **src/pages/PracticeSessionPage.tsx** - Same
10. **src/pages/BandMembersPage.tsx** - Same
11. **src/pages/SettingsPage.tsx** - Same

**Changes per page:**

```tsx
// BEFORE
import { ModernLayout } from '../components/layout/ModernLayout'
// ...
return <ModernLayout>{/* page content */}</ModernLayout>

// AFTER
// Remove ModernLayout import
// ...
return <>{/* page content - no wrapper needed */}</>
```

## Technical Context

### React Router Outlet Pattern

**Outlet** is a React Router component that renders child route elements. When used in a parent route's element, it provides a "slot" where nested routes render their content.

```tsx
// Parent route
;<Route element={<Layout />}>
  <Route path="/a" element={<PageA />} />
  <Route path="/b" element={<PageB />} />
</Route>

// Layout component
const Layout = () => (
  <div>
    <Navbar />
    <main>
      <Outlet /> {/* PageA or PageB renders here */}
    </main>
  </div>
)
```

**Not currently used in codebase** - this will be the first use of Outlet pattern.

### Loading State Design

**ContentLoadingSpinner should:**

- Use `bg-[#0a0a0a]` to match ModernLayout's main content area
- Be vertically centered in the content area
- Use amber-500 spinner color (matches existing AuthLoadingSpinner)
- Include "Loading..." text

**Sizing:**

- NOT `min-h-screen` (that's for full page)
- Use `min-h-[calc(100vh-4rem)]` or similar to fill content area
- Or simply `flex-1` if parent uses flex layout

## Testing Requirements

### Unit Tests

**ProtectedLayoutRoute.test.tsx** (new)

- Test auth check integration
- Test redirect logic for different failure reasons
- Test loading state shows ContentLoadingSpinner
- Test successful auth renders Outlet
- Test sessionExpired triggers redirect

**ContentLoadingSpinner.test.tsx** (new)

- Test renders with dark theme background
- Test spinner animation present
- Test "Loading..." text displayed

### Integration Tests

**Layout Persistence Test**

- Navigate between protected routes
- Verify ModernLayout (sidebar, header) stays mounted
- Verify only content area re-renders

### E2E Tests

**Navigation Flicker Test**

- Start on /songs
- Navigate to /setlists
- Verify no white screen flash
- Verify sidebar remains visible throughout
- Verify header remains visible throughout

## Risk Analysis

### High Risk

**Route Structure Changes:**

- **Impact:** All protected routes affected
- **Mitigation:**
  - Implement incrementally (create new components first)
  - Test each route after restructuring
  - Keep old ProtectedRoute as fallback initially

### Medium Risk

**Outlet Pattern (New to Codebase):**

- **Impact:** Team unfamiliar with pattern
- **Mitigation:**
  - Document pattern clearly in code comments
  - Add examples in research doc

**Page Component Changes:**

- **Impact:** 11 files need ModernLayout removed
- **Mitigation:**
  - Create checklist
  - Use grep to verify all instances found
  - Test each page after changes

### Low Risk

**Loading Spinner Styling:**

- **Impact:** Minor visual change
- **Mitigation:** Match existing theme colors exactly

## Recommended Approach

### Phase 1: Create Infrastructure

1. Create `ContentLoadingSpinner` component
2. Create `ProtectedLayoutRoute` component
3. Write unit tests for both

### Phase 2: Restructure Routes

1. Update App.tsx to use nested layout route
2. Keep old ProtectedRoute temporarily
3. Test routing works correctly

### Phase 3: Update Pages

1. Remove ModernLayout from all 11 pages (one at a time)
2. Test each page renders correctly within layout
3. Remove unused imports

### Phase 4: Testing & Cleanup

1. Run all existing tests
2. Add E2E test for navigation smoothness
3. Remove old ProtectedRoute if fully replaced
4. Update any affected documentation

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│ App.tsx                                                         │
│  └─ Routes                                                      │
│     ├─ Route element={<ProtectedLayoutRoute />}                 │
│     │   │                                                       │
│     │   │  ┌─────────────────────────────────────────────────┐ │
│     │   │  │ ProtectedLayoutRoute                            │ │
│     │   │  │  ├─ useAuthCheck() → isChecking, isAuthenticated│ │
│     │   │  │  ├─ Redirect logic for auth failures            │ │
│     │   │  │  │                                              │ │
│     │   │  │  └─ ModernLayout (ALWAYS RENDERED)              │ │
│     │   │  │      ├─ Sidebar (desktop)                       │ │
│     │   │  │      ├─ MobileHeader                            │ │
│     │   │  │      ├─ MobileDrawer                            │ │
│     │   │  │      └─ main                                    │ │
│     │   │  │          └─ {isChecking ? Spinner : <Outlet />} │ │
│     │   │  └─────────────────────────────────────────────────┘ │
│     │   │                                                       │
│     │   ├─ /songs → SongsPage (content only)                   │
│     │   ├─ /setlists → SetlistsPage (content only)             │
│     │   ├─ /setlists/new → SetlistViewPage                     │
│     │   ├─ /setlists/:id → SetlistViewPage                     │
│     │   ├─ /shows → ShowsPage                                  │
│     │   ├─ /shows/new → ShowViewPage                           │
│     │   ├─ /shows/:id → ShowViewPage                           │
│     │   ├─ /practices → PracticesPage                          │
│     │   ├─ /practices/new → PracticeViewPage                   │
│     │   ├─ /practices/:id → PracticeViewPage                   │
│     │   ├─ /practices/:id/edit → PracticeBuilderPage           │
│     │   ├─ /practices/:id/session → PracticeSessionPage        │
│     │   ├─ /band-members → BandMembersPage                     │
│     │   ├─ /settings → SettingsPage                            │
│     │   └─ / → Navigate to /songs                              │
│     │                                                           │
│     ├─ /auth → AuthPages (no layout)                           │
│     ├─ /auth/callback → AuthCallback (no layout)               │
│     ├─ /get-started → AuthPages (no layout)                    │
│     └─ /dev/* → DevDashboard (no layout)                       │
└─────────────────────────────────────────────────────────────────┘
```

## Summary

**Problem:** White screen flicker during navigation because ModernLayout is inside each page, which unmounts during ProtectedRoute's auth check.

**Solution:** Hoist ModernLayout to a layout route that wraps all protected routes. Auth check loading state shows within the content area only, keeping navbar/sidebar visible.

**Key Changes:**

- New `ProtectedLayoutRoute` component with Outlet pattern
- New `ContentLoadingSpinner` for content-area loading
- Remove ModernLayout from 11 page components
- Restructure App.tsx routes to use layout route

**Estimated Complexity:** Medium

- Clear pattern (React Router layout routes)
- Straightforward file changes
- Main risk is route restructuring (mitigated by incremental approach)

**Ready for Planning:** Yes

---

## Test Impact Analysis

### Overview

**Total E2E Tests:** ~113+ tests across 14 test files
**Estimated to Pass Without Changes:** ~110+ (97%)
**Needing Verification:** 1-3 tests (3%)

The persistent-layout feature will have **minimal impact on existing tests** because:

- It doesn't alter authentication logic (useAuthCheck unchanged)
- It doesn't change route navigation behavior (URLs stay the same)
- It doesn't affect business logic tests
- Only changes how layout components are organized

### Unit Tests

#### Tests That Will Pass Without Changes

| Test File               | Test Count | Impact | Reason                                     |
| ----------------------- | ---------- | ------ | ------------------------------------------ |
| `useAuthCheck.test.tsx` | 60+        | PASS   | Tests hook logic, not layout structure     |
| `SetlistsPage.test.tsx` | 12         | PASS   | Tests hooks, doesn't render full component |

#### Missing Unit Tests (Gap Identified)

- No unit tests currently render page components with ModernLayout
- No tests verify layout structure, sidebar, header, responsive behavior
- **Recommendation:** Add unit tests for ProtectedLayoutRoute and ContentLoadingSpinner

### E2E Tests

#### Tests That Will Pass Without Changes

| Test File                  | Test Count | Impact | Notes                                |
| -------------------------- | ---------- | ------ | ------------------------------------ |
| `protected-routes.spec.ts` | 10         | PASS   | Tests URLs and redirects, not layout |
| `session-expiry.spec.ts`   | 12         | PASS   | Tests auth flows, not layout         |
| `songs/crud.spec.ts`       | 15+        | PASS   | Tests business logic                 |
| `practices/crud.spec.ts`   | 20+        | PASS   | Tests business logic                 |
| `create-band.spec.ts`      | 8+         | PASS   | Tests band creation                  |
| `manage-members.spec.ts`   | 15+        | PASS   | Tests member management              |
| `band-isolation.spec.ts`   | 7+         | PASS   | Tests data isolation                 |
| `search-filter.spec.ts`    | 6+         | PASS   | Tests filtering                      |
| `sync/*.spec.ts`           | 4+         | PASS   | Tests sync logic                     |
| `rbac.spec.ts`             | 8+         | PASS   | Tests permissions                    |

#### Tests Requiring Verification

**1. settings-page.spec.ts** (18+ tests)

- **Concern:** Tests click `[data-testid="settings-link"]` in sidebar and verify `[data-testid="settings-page"]`
- **Risk:** If `settings-page` testid is removed when removing ModernLayout wrapper
- **Mitigation:** Ensure all pages retain their `data-testid="{page-name}-page"` attribute

**2. protected-routes.spec.ts - "No Flash of Content" test**

- **Concern:** Test verifies no content appears before redirect on unauthenticated access
- **Risk:** Layout might briefly render before redirect logic kicks in
- **Mitigation:** Ensure redirect logic runs before ModernLayout renders

### Critical data-testid Attributes to Preserve

**Sidebar.tsx** (Layout Component - Unchanged):

```
[data-testid="sidebar-band-name"]     ✅ Keep
[data-testid="songs-link"]            ✅ Keep
[data-testid="setlists-link"]         ✅ Keep
[data-testid="shows-link"]            ✅ Keep
[data-testid="practices-link"]        ✅ Keep
[data-testid="band-members-link"]     ✅ Keep
[data-testid="settings-link"]         ✅ Keep (used in E2E)
[data-testid="logout-button"]         ✅ Keep
```

**ProtectedRoute.tsx** (May be deprecated):

```
[data-testid="auth-loading-spinner"]  ⚠️ Move to ProtectedLayoutRoute
```

**Page Components** (Need to verify after ModernLayout removal):

```
[data-testid="settings-page"]         ✅ Must preserve
[data-testid="songs-page"]            ✅ Must preserve (if exists)
... other page testids
```

### New Tests to Add

#### 1. Layout Persistence Test (E2E)

```typescript
test('should maintain layout when navigating between routes', async ({
  page,
}) => {
  await page.goto('/songs')
  await expect(page.getByTestId('sidebar-band-name')).toBeVisible()

  await page.click('[data-testid="setlists-link"]')
  await expect(page).toHaveURL(/\/setlists/)
  // Sidebar should still be visible (no remount)
  await expect(page.getByTestId('sidebar-band-name')).toBeVisible()

  await page.click('[data-testid="practices-link"]')
  await expect(page).toHaveURL(/\/practices/)
  await expect(page.getByTestId('sidebar-band-name')).toBeVisible()
})
```

#### 2. Content Loading Spinner Test (E2E)

```typescript
test('should show content spinner during page transitions', async ({
  page,
}) => {
  // Slow down network to see spinner
  await page.route('**/*', route => {
    setTimeout(() => route.continue(), 100)
  })

  await page.goto('/songs')
  // Should show spinner briefly, then content
  await expect(page.getByTestId('content-loading-spinner')).toBeVisible()
  await expect(page.getByTestId('songs-page')).toBeVisible()
})
```

#### 3. Unit Tests for New Components

```typescript
// ProtectedLayoutRoute.test.tsx
- renders ModernLayout wrapper
- shows ContentLoadingSpinner when isChecking=true
- renders Outlet when authenticated
- redirects to /auth when no user
- redirects to /auth?view=get-started when no band
- redirects to /auth?reason=session-expired when expired

// ContentLoadingSpinner.test.tsx
- renders with dark theme background
- displays spinner animation
- shows "Loading..." text
- has correct data-testid
```

### Implementation Checklist for Tests

Before implementation:

- [ ] Run `npm run test:e2e` to get baseline pass rate
- [ ] Run `npm test` for unit test baseline
- [ ] Document current test results

During implementation:

- [ ] Keep `data-testid="auth-loading-spinner"` in ProtectedLayoutRoute
- [ ] Add `data-testid="content-loading-spinner"` to ContentLoadingSpinner
- [ ] Preserve all page-level `data-testid` attributes
- [ ] Preserve all sidebar/nav `data-testid` attributes

After implementation:

- [ ] Run full E2E suite - verify ~97% pass
- [ ] Check "No Flash of Content" test in protected-routes.spec.ts
- [ ] Check settings-page navigation tests
- [ ] Add new layout persistence E2E test
- [ ] Add unit tests for new components

### Responsive Layout Considerations

**Current CSS Classes in ModernLayout:**

```css
md:ml-60     /* Desktop sidebar margin */
pt-16        /* Mobile header padding */
md:pt-0      /* No padding on desktop */
```

**Test Implications:**

- E2E tests run at ~1280px width (desktop viewport)
- No existing mobile responsive tests
- **Gap:** Consider adding mobile layout tests separately

### Summary

| Category   | Status    | Action                                   |
| ---------- | --------- | ---------------------------------------- |
| Unit Tests | LOW RISK  | Add new tests for new components         |
| E2E Tests  | LOW RISK  | Verify 2-3 tests after implementation    |
| Test IDs   | PRESERVED | Keep all existing data-testid attributes |
| New Tests  | REQUIRED  | Add layout persistence + spinner tests   |

**Conclusion:** The refactoring is safe from a testing perspective. Most tests verify business logic and URLs, not layout structure. The main actions are:

1. Preserve all `data-testid` attributes
2. Verify settings page navigation test still passes
3. Add new tests for layout persistence behavior
