---
feature: External Links Enhancements
created: 2026-01-19T23:40
status: research-complete
agent: research-agent
---

# External Links Enhancements - Research

## Overview

Enhance the song external links feature with:

1. **Fix sync issue** - Links currently don't sync between devices
2. **Auto-detect link type** - Parse URL to determine Spotify/YouTube/tabs/etc.
3. **Quick-access icons** - View links from songs list without editing
4. **Expanded metadata display** - Show links + more metadata in expandable section

## Current State Analysis

### 1. Schema Mismatch (Critical Issue)

**Supabase Schema** (`supabase/migrations/20251106000000_baseline_schema.sql:165-167`):

```sql
lyrics_url TEXT,
chords_url TEXT,
recording_url TEXT,
```

**App Model** (`src/models/Song.ts:17`):

```typescript
referenceLinks: ReferenceLink[]
```

**ReferenceLink Type** (`src/types/index.ts:8-12`):

```typescript
export interface ReferenceLink {
  type: 'spotify' | 'youtube' | 'tabs' | 'lyrics' | 'other'
  url: string
  description?: string
}
```

**Problem:** The app uses a flexible array of links with types, but Supabase has three fixed URL columns. The `RemoteRepository` explicitly marks `referenceLinks` as "IndexedDB only":

```typescript
// src/services/data/RemoteRepository.ts:182
referenceLinks: [], // IndexedDB only - not in Supabase
```

**Impact:** Links are saved locally but NEVER sync to Supabase. Users lose links when switching devices.

### 2. Current UI Flow

**EditSongModal** (`src/components/songs/EditSongModal.tsx`):

- User selects link type from dropdown (youtube, spotify, tabs, lyrics, other)
- User enters name and URL manually
- Links displayed in scrollable list with icons
- Links only accessible via Edit Song modal

**Current Link Type Icons:**

```typescript
// EditSongModal.tsx:181-192
case 'spotify': return <Music2 className="text-[#1DB954]" />
case 'youtube': return <Play className="text-[#FF0000]" />
case 'tabs': return <Guitar className="text-[#FFC600]" />
default: return <ExternalLink className="text-[#a0a0a0]" />
```

### 3. Songs List Display

**SongsPage** (`src/pages/SongsPage.tsx`):

- Song row shows: sync icon, title/artist, duration, key, tuning, bpm, next show
- No link icons or quick access
- Expandable section shows notes only (via `ExpandableSongNotes`)

**ExpandableSongNotes** (`src/components/songs/ExpandableSongNotes.tsx`):

- Shows band notes and personal notes
- Expand/collapse toggle with chevron
- Used in: SongsPage, SongListItem (setlists/practices)

### 4. Practice/Setlist Workflow

**PracticeViewPage/SetlistViewPage**:

- Use `SongListItem` component
- Support expandable notes via `ExpandableSongNotes`
- No link display or quick access

## Proposed Solutions

### Fix 1: Sync Reference Links

**Option A: JSONB Column (Recommended)**
Add a `reference_links` JSONB column to songs table:

```sql
ALTER TABLE public.songs ADD COLUMN reference_links JSONB DEFAULT '[]'::jsonb;
```

Pros:

- Preserves flexible array structure
- Single column addition
- Direct mapping to app model

Cons:

- Can't query by individual link URL easily
- Slightly more complex for direct SQL queries

**Option B: Separate Link Table**
Create a `song_links` table:

```sql
CREATE TABLE public.song_links (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  song_id UUID NOT NULL REFERENCES public.songs(id) ON DELETE CASCADE,
  type TEXT NOT NULL CHECK (type IN ('spotify', 'youtube', 'tabs', 'lyrics', 'other')),
  url TEXT NOT NULL,
  description TEXT,
  created_date TIMESTAMPTZ DEFAULT NOW()
);
```

Pros:

- Queryable by link type/URL
- Proper relational structure
- Easier analytics

Cons:

- More complex sync (separate entity)
- Multiple queries needed
- More migration work

**Recommendation:** Option A (JSONB) for simplicity. Can migrate to Option B later if needed.

### Fix 2: URL Auto-Detection

Create a utility function to detect link type from URL:

```typescript
// src/utils/linkDetection.ts

interface LinkTypeInfo {
  type: ReferenceLink['type']
  name: string
  icon: string
}

export function detectLinkType(url: string): LinkTypeInfo {
  const urlLower = url.toLowerCase()

  // Spotify
  if (
    urlLower.includes('spotify.com') ||
    urlLower.includes('open.spotify.com') ||
    urlLower.includes('spoti.fi')
  ) {
    return { type: 'spotify', name: 'Spotify', icon: 'Music2' }
  }

  // YouTube
  if (
    urlLower.includes('youtube.com') ||
    urlLower.includes('youtu.be') ||
    urlLower.includes('m.youtube.com')
  ) {
    return { type: 'youtube', name: 'YouTube', icon: 'Play' }
  }

  // Tabs (Ultimate Guitar, Songsterr, etc.)
  if (
    urlLower.includes('ultimate-guitar.com') ||
    urlLower.includes('tabs.ultimate-guitar.com') ||
    urlLower.includes('songsterr.com') ||
    urlLower.includes('guitartabs.cc') ||
    /\.(gp[345x]?)$/i.test(url)
  ) {
    // Guitar Pro files
    return { type: 'tabs', name: 'Tabs', icon: 'Guitar' }
  }

  // Lyrics
  if (
    urlLower.includes('genius.com') ||
    urlLower.includes('azlyrics.com') ||
    urlLower.includes('lyrics.com') ||
    urlLower.includes('metrolyrics.com')
  ) {
    return { type: 'lyrics', name: 'Lyrics', icon: 'FileText' }
  }

  // Default to other
  return { type: 'other', name: 'Link', icon: 'ExternalLink' }
}
```

**UI Enhancement:**

- When user pastes URL, auto-detect and pre-select type
- User can still override the detected type
- Show detected type with visual feedback

### Fix 3: Quick-Access Link Icons

Add link icons to song row in lists:

**SongsPage SongRow Enhancement:**

```tsx
// After song info, before duration column
<div className="flex items-center gap-1">
  {song.referenceLinks?.map(link => (
    <a
      key={link.url}
      href={link.url}
      target="_blank"
      rel="noopener noreferrer"
      className="p-1 text-[#707070] hover:text-white transition-colors"
      title={link.description || getLinkTypeName(link.type)}
    >
      {getLinkIcon(link.type)}
    </a>
  ))}
</div>
```

**Benefits:**

- One-click access to links
- Visual indicator of what resources are available
- No need to open edit modal

### Fix 4: Expanded Metadata Section

Enhance `ExpandableSongNotes` or create new `ExpandableSongDetails` component:

**Proposed Structure:**

```
[Expand Toggle] Details (or Notes if no links)

  ├─ Links Section (if has links)
  │   ├─ [Spotify Icon] Spotify Track  →
  │   ├─ [YouTube Icon] Tutorial Video  →
  │   └─ [Tabs Icon] Ultimate Guitar  →
  │
  ├─ Band Notes Section
  │   └─ Notes content...
  │
  └─ My Notes Section (private)
      └─ Personal notes...
```

**Alternative: Separate Sections**

- Keep notes expandable as-is
- Add separate link icons inline with song row
- Clicking expand shows notes only

## Affected Files

### Must Modify

| File                                             | Change                                |
| ------------------------------------------------ | ------------------------------------- |
| `supabase/migrations/`                           | Add `reference_links` JSONB column    |
| `src/services/data/RemoteRepository.ts:139-196`  | Add field mapping for reference_links |
| `src/components/songs/EditSongModal.tsx:116-157` | Add auto-detection on URL paste       |
| `src/pages/SongsPage.tsx:471-591`                | Add link icons to SongRow             |
| `src/components/common/SongListItem.tsx`         | Add link icons option                 |

### May Modify

| File                                           | Change                             |
| ---------------------------------------------- | ---------------------------------- |
| `src/components/songs/ExpandableSongNotes.tsx` | Extend to show links               |
| `src/pages/PracticeViewPage.tsx`               | Pass links through to SongListItem |
| `src/pages/SetlistViewPage.tsx`                | Pass links through to SongListItem |
| `src/utils/linkDetection.ts`                   | New file for URL detection         |

### Existing Backlog Research

The sync issue was previously diagnosed:

- `.claude/backlog/song-external-links-sync/2026-01-18T19:45_research.md`

This research supersedes and expands that diagnosis.

## Database Impact

**Migration Required:** Yes (add JSONB column)

```sql
-- New migration: 2026XXXX_add_reference_links_column.sql
ALTER TABLE public.songs
ADD COLUMN reference_links JSONB DEFAULT '[]'::jsonb;

-- Optional: Migrate existing URL columns to new format
UPDATE public.songs SET reference_links = jsonb_build_array(
  CASE WHEN lyrics_url IS NOT NULL THEN
    jsonb_build_object('type', 'lyrics', 'url', lyrics_url, 'description', 'Lyrics')
  END,
  CASE WHEN chords_url IS NOT NULL THEN
    jsonb_build_object('type', 'tabs', 'url', chords_url, 'description', 'Chords')
  END,
  CASE WHEN recording_url IS NOT NULL THEN
    jsonb_build_object('type', 'other', 'url', recording_url, 'description', 'Recording')
  END
) - null
WHERE lyrics_url IS NOT NULL OR chords_url IS NOT NULL OR recording_url IS NOT NULL;
```

**RLS:** No new policies needed (inherits from songs table)

**Realtime:** Will sync automatically via songs table subscription

## Risk Analysis

| Risk                       | Severity | Mitigation                                         |
| -------------------------- | -------- | -------------------------------------------------- |
| Migration failure          | Medium   | Test migration locally first, use transaction      |
| Data loss during migration | Low      | Existing links in IndexedDB, old columns preserved |
| UI breaking on null links  | Low      | Default to empty array, null checks                |
| Auto-detection wrong type  | Low      | User can override, non-blocking                    |

## Open Questions

1. **Should we remove old URL columns after migration?**
   - Recommendation: Keep for backwards compatibility, deprecate later

2. **Should links be displayed inline or in expanded section?**
   - Recommendation: Inline icons for quick access, expanded for details

3. **Should auto-detection be instant or require confirmation?**
   - Recommendation: Instant with visual feedback, easy override

4. **What's the maximum number of links per song?**
   - Current: Unlimited (array)
   - Recommendation: Keep unlimited, UI handles with scroll

## Recommended Approach

1. **Phase 1: Fix Sync (Critical)**
   - Add JSONB column migration
   - Update RemoteRepository field mappings
   - Test sync works both directions

2. **Phase 2: Auto-Detection**
   - Create linkDetection utility
   - Update EditSongModal to auto-detect on paste
   - Add visual feedback for detected type

3. **Phase 3: Quick Access Icons**
   - Add link icons to SongRow in SongsPage
   - Add link icons to SongListItem for setlists/practices

4. **Phase 4: Expanded Metadata (Optional)**
   - Enhance ExpandableSongNotes to show links
   - Or create ExpandableSongDetails component

## Next Steps

After research approval:

```
/plan external-links-enhancements
```
