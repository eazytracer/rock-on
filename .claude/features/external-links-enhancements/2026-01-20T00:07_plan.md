---
feature: External Links Enhancements
created: 2026-01-20T00:07
status: planning
agent: plan-agent
parent-feature: external-links-enhancements
---

# External Links Enhancements - Implementation Plan

## Overview

Phase 1 implementation to fix sync issues and enhance the external links feature with auto-detection, quick-access icons, and optional Spotify search integration.

## Scope (Phase 1)

1. **Fix Sync Issue** - Add JSONB column for reference_links
2. **URL Auto-Detection** - Parse URLs to detect link types automatically
3. **Quick-Access Icons** - View links from song lists without editing
4. **Spotify Search** - Auto-complete search to pre-fill song data (MVP)

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Frontend                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   SongsPage      â”‚    â”‚  EditSongModal   â”‚    â”‚  SongListItem    â”‚       â”‚
â”‚  â”‚                  â”‚    â”‚                  â”‚    â”‚  (setlist/       â”‚       â”‚
â”‚  â”‚ + Link icons     â”‚    â”‚ + Auto-detect    â”‚    â”‚   practice)      â”‚       â”‚
â”‚  â”‚   per song row   â”‚    â”‚   on URL paste   â”‚    â”‚                  â”‚       â”‚
â”‚  â”‚                  â”‚    â”‚                  â”‚    â”‚ + Link icons     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ + SpotifySearch  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚           â”‚              â”‚   component      â”‚             â”‚                  â”‚
â”‚           â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚                  â”‚
â”‚           â”‚                       â”‚                       â”‚                  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                   â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     Shared Components                                   â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚  â”‚ LinkTypeIcons   â”‚    â”‚ SpotifySearch   â”‚    â”‚ linkDetection   â”‚     â”‚ â”‚
â”‚  â”‚  â”‚ (shared icons)  â”‚    â”‚ (autocomplete)  â”‚    â”‚ (utility)       â”‚     â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â”‚                                  â”‚                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     Services Layer                                      â”‚ â”‚
â”‚  â”‚                                  â”‚                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                              â”‚ â”‚
â”‚  â”‚  â”‚ RemoteRepositoryâ”‚    â”‚SpotifyService â”‚                              â”‚ â”‚
â”‚  â”‚  â”‚ + reference_    â”‚    â”‚ (API wrapper) â”‚                              â”‚ â”‚
â”‚  â”‚  â”‚   links mapping â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                                      â”‚ â”‚
â”‚  â”‚                                 â”‚                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Supabase                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ songs table      â”‚           â”‚ Edge Function:   â”‚                        â”‚
â”‚  â”‚                  â”‚           â”‚ spotify-search   â”‚                        â”‚
â”‚  â”‚ + reference_linksâ”‚           â”‚                  â”‚                        â”‚
â”‚  â”‚   JSONB column   â”‚           â”‚ - Get app token  â”‚                        â”‚
â”‚  â”‚                  â”‚           â”‚ - Search Spotify â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ - Transform data â”‚                        â”‚
â”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                          â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Spotify Web API        â”‚
                              â”‚ GET /v1/search?type=   â”‚
                              â”‚     track              â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Database Changes

### Migration: Add reference_links JSONB column

**File:** `supabase/migrations/20251106000000_baseline_schema.sql` (modify baseline per pre-1.0 policy)

```sql
-- Add to songs table definition (after existing URL columns)
reference_links JSONB DEFAULT '[]'::jsonb,

-- Optional: Migrate existing URL columns to new format
-- This can be a separate data migration script
```

**JSONB Structure:**

```json
[
  {
    "type": "spotify",
    "url": "https://open.spotify.com/track/xxx",
    "description": "Spotify Track"
  },
  {
    "type": "youtube",
    "url": "https://youtube.com/watch?v=xxx",
    "description": "Tutorial Video"
  }
]
```

### Backward Compatibility

- Keep existing `lyrics_url`, `chords_url`, `recording_url` columns
- New `reference_links` column is the source of truth
- Can migrate data later or deprecate old columns post-1.0

## File Structure

### New Files

| File                                         | Purpose                                  |
| -------------------------------------------- | ---------------------------------------- |
| `src/utils/linkDetection.ts`                 | URL pattern detection utility            |
| `src/components/songs/LinkIcons.tsx`         | Shared link icon components              |
| `src/services/spotify/SpotifyService.ts`     | Spotify API client (calls Edge Function) |
| `src/components/songs/SpotifySearch.tsx`     | Autocomplete search component            |
| `src/hooks/useSpotifySearch.ts`              | Debounced search hook                    |
| `supabase/functions/spotify-search/index.ts` | Edge Function for Spotify API            |

### Modified Files

| File                                                     | Changes                               |
| -------------------------------------------------------- | ------------------------------------- |
| `supabase/migrations/20251106000000_baseline_schema.sql` | Add `reference_links` JSONB column    |
| `src/services/data/RemoteRepository.ts`                  | Add field mapping for reference_links |
| `src/components/songs/EditSongModal.tsx`                 | Add URL auto-detection, SpotifySearch |
| `src/pages/SongsPage.tsx`                                | Add link icons to song rows           |
| `src/components/common/SongListItem.tsx`                 | Add link icons option                 |

## Component Specifications

### 1. linkDetection.ts

```typescript
// src/utils/linkDetection.ts

export type LinkType = 'spotify' | 'youtube' | 'tabs' | 'lyrics' | 'other'

export interface LinkTypeInfo {
  type: LinkType
  name: string
  iconName: string // Lucide icon name
  color: string // Tailwind color class
}

export function detectLinkType(url: string): LinkTypeInfo
export function getLinkTypeInfo(type: LinkType): LinkTypeInfo
```

**Detection patterns:**

- Spotify: `spotify.com`, `open.spotify.com`, `spoti.fi`
- YouTube: `youtube.com`, `youtu.be`, `m.youtube.com`
- Tabs: `ultimate-guitar.com`, `songsterr.com`, `.gp[345x]?$`
- Lyrics: `genius.com`, `azlyrics.com`, `lyrics.com`
- Other: default fallback

### 2. LinkIcons.tsx

```typescript
// src/components/songs/LinkIcons.tsx

interface LinkIconsProps {
  links: ReferenceLink[]
  size?: 'sm' | 'md' // sm for lists, md for details
  showEmpty?: boolean // Show placeholder when no links
}

export const LinkIcons: React.FC<LinkIconsProps>
export const LinkIcon: React.FC<{ type: LinkType; size?: 'sm' | 'md' }>
```

### 3. SpotifySearch.tsx

```typescript
// src/components/songs/SpotifySearch.tsx

interface SpotifySearchProps {
  onSelect: (track: SpotifyTrack) => void
  placeholder?: string
}

interface SpotifyTrack {
  id: string
  name: string
  artist: string
  album: string
  durationMs: number
  spotifyUrl: string
  albumArt?: string
}

export const SpotifySearch: React.FC<SpotifySearchProps>
```

**Features:**

- Debounced input (300ms)
- Minimum 3 characters before search
- Shows track name, artist, album art
- Click to select and auto-fill form

### 4. SpotifyService.ts

```typescript
// src/services/spotify/SpotifyService.ts

export interface SpotifySearchResult {
  tracks: SpotifyTrack[]
  hasMore: boolean
}

export class SpotifyService {
  async searchTracks(
    query: string,
    limit?: number
  ): Promise<SpotifySearchResult>
}
```

**Implementation:**

- Calls Supabase Edge Function (not Spotify directly)
- Handles rate limit errors gracefully
- Caches recent searches (optional)

### 5. spotify-search Edge Function

```typescript
// supabase/functions/spotify-search/index.ts

// Request: { query: string, limit?: number }
// Response: { tracks: SpotifyTrack[] }

// Flow:
// 1. Get/refresh client credentials token (cache 1 hour)
// 2. Call Spotify /v1/search?type=track
// 3. Transform response to simplified format
// 4. Return to client
```

**Environment variables needed:**

- `SPOTIFY_CLIENT_ID`
- `SPOTIFY_CLIENT_SECRET`

## RemoteRepository Changes

### Current State (src/services/data/RemoteRepository.ts:139-196)

```typescript
// Line 182
referenceLinks: [], // IndexedDB only - not in Supabase
```

### Required Changes

```typescript
// In mapSongToSupabase (around line 160)
reference_links: JSON.stringify(song.referenceLinks || []),

// In mapSongFromSupabase (around line 180)
referenceLinks: data.reference_links
  ? JSON.parse(data.reference_links)
  : [],
```

**Note:** Supabase JSONB handles JSON serialization, but we may need to ensure proper typing.

## UI/UX Flow

### Adding a Link (EditSongModal)

```
1. User clicks "Add Link"
2. URL input field appears with paste detection
3. On paste/type:
   - Auto-detect link type from URL
   - Pre-select type in dropdown
   - User can override if needed
4. User optionally enters description
5. Save adds to referenceLinks array
```

### Adding a Song with Spotify (EditSongModal)

```
1. User clicks "Search Spotify" button/icon
2. SpotifySearch component appears
3. User types song name (debounced)
4. Results show: track name, artist, album art
5. User clicks result:
   - Title auto-filled
   - Artist auto-filled
   - Duration auto-filled
   - Spotify link added to referenceLinks
6. User can still manually edit any field
```

### Viewing Links (SongsPage)

```
Song Row:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Sync] Title - Artist        [ğŸµ][â–¶][ğŸ¸]    4:32  | Key | BPM      â”‚
â”‚                               â†‘  â†‘  â†‘                              â”‚
â”‚                     Spotify  YouTube  Tabs                         â”‚
â”‚                     (clickable icons)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

- Icons are subtle (gray) until hover
- Click opens link in new tab
- Tooltip shows description or type name
```

## Testing Strategy

### Unit Tests

| Test File                                            | Coverage              |
| ---------------------------------------------------- | --------------------- |
| `tests/unit/utils/linkDetection.test.ts`             | URL pattern detection |
| `tests/unit/services/spotify/SpotifyService.test.ts` | API service (mocked)  |
| `tests/unit/components/songs/LinkIcons.test.tsx`     | Icon rendering        |
| `tests/unit/components/songs/SpotifySearch.test.tsx` | Search component      |
| `tests/unit/hooks/useSpotifySearch.test.ts`          | Debounce behavior     |

### Integration Tests

| Test File                                          | Coverage            |
| -------------------------------------------------- | ------------------- |
| `tests/integration/RemoteRepository.links.test.ts` | JSONB field mapping |

### E2E Tests

| Test File                          | Coverage                   |
| ---------------------------------- | -------------------------- |
| `tests/e2e/song-links.spec.ts`     | Add/view/edit links flow   |
| `tests/e2e/spotify-search.spec.ts` | Spotify search integration |

### Database Tests

| Test File                                     | Coverage           |
| --------------------------------------------- | ------------------ |
| `supabase/tests/012-reference-links.test.sql` | JSONB column, sync |

## Risk Mitigation

| Risk                    | Mitigation                           |
| ----------------------- | ------------------------------------ |
| Spotify API unavailable | Graceful fallback to manual entry    |
| Rate limiting           | Debounce, cache, exponential backoff |
| JSONB migration issues  | Test locally first, keep old columns |
| Link detection wrong    | User can always override type        |

## Implementation Order

The implementation follows TDD principles with this order:

1. **Phase 1: Database Setup**
   - Add JSONB column to baseline migration
   - Update RemoteRepository field mappings
   - Test sync works

2. **Phase 2: Core Utilities**
   - Create linkDetection utility
   - Create LinkIcons component
   - Write unit tests

3. **Phase 3: UI Integration**
   - Add auto-detection to EditSongModal
   - Add link icons to SongsPage
   - Add link icons to SongListItem

4. **Phase 4: Spotify Integration** (can be parallel)
   - Create Edge Function
   - Create SpotifyService
   - Create SpotifySearch component
   - Integrate into EditSongModal

5. **Phase 5: Polish**
   - E2E tests
   - Error handling improvements
   - Documentation

## Environment Setup

### Spotify Developer Setup

1. Create app at https://developer.spotify.com/dashboard
2. Note Client ID and Client Secret
3. Add to Supabase secrets:
   ```bash
   supabase secrets set SPOTIFY_CLIENT_ID=xxx
   supabase secrets set SPOTIFY_CLIENT_SECRET=xxx
   ```

### Local Development

For local testing of Edge Function:

```bash
# In .env.local (gitignored)
SPOTIFY_CLIENT_ID=xxx
SPOTIFY_CLIENT_SECRET=xxx
```

## Open Decisions

1. **Should Spotify search be optional?**
   - Recommendation: Yes, make it a "nice to have" button, not required

2. **Link icons placement in song row?**
   - Recommendation: After title/artist, before duration column

3. **Maximum links displayed inline?**
   - Recommendation: Show first 3-4, overflow indicator for more

## Next Steps

After plan approval, proceed with:

```
/implement external-links-enhancements
```
