# Enhanced Security Testing Research

**Created:** 2026-01-06T16:33
**Feature:** enhanced-security-testing
**Status:** Research Phase

## Executive Summary

This document outlines the research findings for implementing comprehensive security testing in the rock-on application's CICD workflow. The goal is to ensure route security, validate RLS policies, prevent sensitive data exposure, and integrate security testing into the development lifecycle before user onboarding.

---

## Current State Analysis

### Existing Security Infrastructure

#### Authentication (`src/services/auth/SupabaseAuthService.ts:1-454`)

- Uses Supabase Auth with JWT tokens
- Supports email/password and Google OAuth
- Session management with auto-refresh tokens
- Proper token clearing on logout

#### Supabase Client Configuration (`src/services/supabase/client.ts:1-37`)

- Uses `@supabase/supabase-js` client library
- Configured with `autoRefreshToken: true` and `persistSession: true`
- URL and anon key loaded from environment config
- **Good:** Client only initialized when Supabase auth is enabled

#### RLS Policy Testing (`supabase/tests/006-rls-policies.test.sql:1-556`)

- 83 pgTAP tests validating RLS policy existence
- Validates RLS enabled on all 19 tables
- Tests policy counts and command types (SELECT, INSERT, UPDATE, DELETE)
- **Gap:** Tests existence only, not behavioral correctness

#### Current CI/CD (`.github/workflows/ci.yml:1-71`)

- ESLint for code quality
- TypeScript type checking
- Prettier formatting checks
- Unit tests with coverage
- **Gap:** No security-specific scanning

### Identified Security Gaps

| Gap                    | Risk Level | Description                                             |
| ---------------------- | ---------- | ------------------------------------------------------- |
| No SAST scanning       | High       | No static analysis for security vulnerabilities in code |
| No dependency scanning | High       | npm packages not scanned for known CVEs                 |
| No secrets detection   | High       | No automated detection of hardcoded secrets             |
| RLS behavior untested  | Medium     | Policy existence tested, but not actual isolation       |
| No HTTPS verification  | Medium     | No automated check that all Supabase calls use HTTPS    |
| No API security tests  | Medium     | No testing for common API vulnerabilities               |

---

## Recommended Security Tools

### 1. Static Application Security Testing (SAST)

#### Tier 1: Semgrep (Recommended)

**Why Semgrep:**

- Lightweight, fast scanning
- Excellent TypeScript/React support
- Free tier available for open source
- Native GitHub Actions integration
- Custom rule support for project-specific patterns

**Implementation:**

```yaml
# .github/workflows/security.yml
name: Security Scan
on: [push, pull_request]

jobs:
  semgrep:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/react
            p/typescript
            p/security-audit
            p/owasp-top-ten
```

**Estimated effort:** 2-4 hours

#### Tier 2: ESLint Security Plugins

**Plugins to add:**

- `eslint-plugin-security` - General JS security rules
- `eslint-plugin-no-secrets` - Detect hardcoded secrets
- `@microsoft/eslint-plugin-sdl` - Microsoft SDL security rules

**Implementation:**

```bash
npm install --save-dev eslint-plugin-security eslint-plugin-no-secrets
```

```javascript
// eslint.config.js additions
{
  plugins: ['security', 'no-secrets'],
  extends: ['plugin:security/recommended'],
  rules: {
    'no-secrets/no-secrets': 'error',
    'security/detect-object-injection': 'warn',
    'security/detect-non-literal-fs-filename': 'error',
  }
}
```

**Estimated effort:** 1-2 hours

### 2. Dependency Vulnerability Scanning

#### Tier 1: Snyk (Recommended for production)

**Why Snyk:**

- More comprehensive CVE database than npm audit
- Prioritized by exploitability
- Automatic fix PRs
- SBOM generation support

**Implementation:**

```yaml
# .github/workflows/security.yml
snyk-scan:
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4
    - name: Run Snyk to check for vulnerabilities
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high
```

**Free tier:** 200 tests/month for open source

#### Tier 2: npm audit (Zero cost)

**Built into npm, minimal setup:**

```yaml
dependency-check:
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4
    - run: npm ci
    - run: npm audit --audit-level=high
```

**Estimated effort:** 30 minutes

### 3. RLS Policy Testing

#### Tier 1: Supashield CLI (Recommended)

**Why Supashield:**

- Purpose-built for Supabase RLS testing
- Tests actual policy behavior, not just existence
- Coverage reports
- Storage bucket testing support

**Installation:**

```bash
npm install -g supashield
```

**Commands:**

```bash
supashield audit          # Scan for common RLS security issues
supashield coverage       # Generate RLS coverage reports
supashield test           # Test all table RLS policies
supashield test-storage   # Test storage bucket policies
supashield snapshot       # Save current RLS state
```

**CI Integration:**

```yaml
rls-audit:
  runs-on: ubuntu-latest
  services:
    postgres:
      image: supabase/postgres:15
  steps:
    - uses: actions/checkout@v4
    - run: supabase start
    - run: npx supashield audit --fail-on-critical
    - run: npx supashield test
```

**Estimated effort:** 4-6 hours (including test setup)

#### Tier 2: Enhanced pgTAP Tests

Extend existing pgTAP tests to validate actual RLS behavior:

```sql
-- supabase/tests/012-rls-behavior.test.sql
BEGIN;
SELECT plan(10);

-- Test: User A cannot see User B's band data
SELECT set_config('request.jwt.claims', '{"sub": "user-a-uuid"}', true);

SELECT is(
  (SELECT count(*) FROM bands WHERE id = 'user-b-band-id'),
  0::bigint,
  'User A should not see User B band'
);

-- Test: Band member CAN see their band's songs
SELECT set_config('request.jwt.claims', '{"sub": "user-a-uuid"}', true);

SELECT ok(
  (SELECT count(*) FROM songs WHERE context_id = 'user-a-band-id') > 0,
  'User A should see their own band songs'
);

SELECT * FROM finish();
ROLLBACK;
```

**Estimated effort:** 8-12 hours for comprehensive coverage

### 4. HTTPS/TLS Verification

#### Supabase Communication Security

**Current state:** Supabase automatically enforces HTTPS for all HTTP APIs (PostgREST, Storage, Auth).

**Verification tests to add:**

```typescript
// tests/security/https-verification.test.ts
import { describe, it, expect } from 'vitest'

describe('Supabase Connection Security', () => {
  it('should use HTTPS URL', () => {
    const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
    expect(supabaseUrl).toMatch(/^https:\/\//)
  })

  it('should not expose service role key in frontend', () => {
    expect(import.meta.env.VITE_SUPABASE_SERVICE_ROLE_KEY).toBeUndefined()
  })

  it('should only expose anon key', () => {
    const anonKey = import.meta.env.VITE_SUPABASE_ANON_KEY
    expect(anonKey).toBeDefined()
    // Anon keys start with 'eyJ' (base64 JWT)
    expect(anonKey).toMatch(/^eyJ/)
  })
})
```

#### SSL Mode Verification

For direct Postgres connections (if used):

```typescript
// Ensure verify-full SSL mode for production
const connectionConfig = {
  ssl: {
    rejectUnauthorized: true,
    ca: fs.readFileSync('supabase-ca-cert.pem'),
  },
}
```

**Estimated effort:** 2-3 hours

### 5. API Security Testing

#### OWASP ZAP for DAST (Dynamic Testing)

**For testing the running application:**

```yaml
# .github/workflows/dast.yml
dast-scan:
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4
    - name: Start application
      run: npm run build && npm run preview &
    - name: OWASP ZAP Scan
      uses: zaproxy/action-baseline@v0.10.0
      with:
        target: 'http://localhost:4173'
        rules_file_name: '.zap/rules.tsv'
```

**Estimated effort:** 4-6 hours

### 6. Secrets Detection

#### Gitleaks (Recommended)

**Pre-commit and CI scanning:**

```yaml
# .github/workflows/security.yml
secrets-scan:
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

**Local pre-commit hook:**

```bash
# .husky/pre-commit
npx gitleaks detect --source . --verbose
```

**Estimated effort:** 1-2 hours

---

## Implementation Priority

### Phase 1: Quick Wins (Week 1)

| Tool                      | Effort  | Impact |
| ------------------------- | ------- | ------ |
| npm audit in CI           | 30 min  | High   |
| ESLint security plugins   | 2 hours | Medium |
| Gitleaks secrets scanning | 2 hours | High   |
| HTTPS verification tests  | 2 hours | Medium |

### Phase 2: Core Security (Week 2-3)

| Tool                     | Effort   | Impact |
| ------------------------ | -------- | ------ |
| Semgrep SAST             | 4 hours  | High   |
| Supashield RLS audit     | 6 hours  | High   |
| Enhanced pgTAP RLS tests | 12 hours | High   |

### Phase 3: Advanced Testing (Week 4+)

| Tool                 | Effort  | Impact |
| -------------------- | ------- | ------ |
| Snyk integration     | 2 hours | High   |
| OWASP ZAP DAST       | 6 hours | Medium |
| Custom Semgrep rules | 4 hours | Medium |

---

## Specific Security Concerns to Test

### 1. Route Security Validation

```typescript
// What to test:
// - All API routes require authentication
// - Proper token validation on protected routes
// - No sensitive data in URL parameters
// - CORS configuration is restrictive

// tests/security/route-security.test.ts
describe('Route Security', () => {
  it('should reject unauthenticated requests to protected endpoints', async () => {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/songs`, {
      headers: { apikey: ANON_KEY }, // No auth token
    })
    expect(response.status).toBe(401)
  })
})
```

### 2. Data Exposure Prevention

```typescript
// What to test:
// - No sensitive fields exposed (passwords, tokens)
// - PII properly handled
// - Response data matches user's access level

describe('Data Exposure', () => {
  it('should not expose other users email in band members', async () => {
    const members = await getBandMembers(bandId)
    members.forEach(member => {
      if (member.userId !== currentUserId) {
        expect(member.email).toBeUndefined()
      }
    })
  })
})
```

### 3. RLS Policy Behavioral Tests

```sql
-- Test cross-tenant isolation
-- supabase/tests/012-rls-cross-tenant.test.sql

-- Setup: Create two users with different bands
SELECT tests.create_supabase_user('user-alice', 'alice@test.com');
SELECT tests.create_supabase_user('user-bob', 'bob@test.com');

-- Test: Alice cannot access Bob's songs
SELECT tests.authenticate_as('user-alice');
SELECT is_empty(
  'SELECT * FROM songs WHERE context_id IN (SELECT id FROM bands WHERE id = ''bob-band-id'')',
  'Alice should not see Bob''s band songs'
);
```

---

## CI/CD Integration Blueprint

### Complete Security Workflow

```yaml
# .github/workflows/security.yml
name: Security Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 1' # Weekly full scan

jobs:
  # Fast checks - run on every PR
  quick-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: npm audit
        run: npm audit --audit-level=high

      - name: ESLint security
        run: npm run lint -- --rule 'security/detect-object-injection:error'

      - name: Check for secrets
        uses: gitleaks/gitleaks-action@v2

  # SAST scanning
  sast:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: returntocorp/semgrep-action@v1
        with:
          config: p/typescript p/react p/security-audit

  # RLS policy validation (requires Supabase)
  rls-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: supabase/setup-cli@v1

      - name: Start Supabase
        run: supabase start

      - name: Run pgTAP tests
        run: npm run test:db

      - name: RLS audit
        run: npx supashield audit --fail-on-critical

  # Weekly deep scan
  deep-scan:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
```

---

## Open Questions

1. **Budget for paid tools:** Do we have budget for Snyk Pro or should we stick with free tiers?

2. **Production database access:** Can we run RLS tests against staging/production to verify real policies?

3. **E2E security tests:** Should we add Playwright tests that specifically verify authentication flows and authorization?

4. **Penetration testing:** Is formal pen testing on the roadmap before production launch?

5. **Compliance requirements:** Are there specific compliance frameworks (SOC2, GDPR, HIPAA) we need to target?

---

## Related Files

| File                                                     | Purpose                               |
| -------------------------------------------------------- | ------------------------------------- |
| `src/services/auth/SupabaseAuthService.ts`               | Authentication implementation         |
| `src/services/supabase/client.ts`                        | Supabase client configuration         |
| `src/services/data/RemoteRepository.ts`                  | Data access layer (RLS enforced here) |
| `supabase/tests/006-rls-policies.test.sql`               | Existing RLS policy tests             |
| `.github/workflows/ci.yml`                               | Current CI workflow                   |
| `supabase/migrations/20251106000000_baseline_schema.sql` | RLS policy definitions                |

---

## References

### SAST/DAST Tools

- [GitLab SAST Documentation](https://docs.gitlab.com/user/application_security/sast/)
- [Semgrep Sample CI Configs](https://semgrep.dev/docs/semgrep-ci/sample-ci-configs)
- [Top 10 SAST Tools 2025 - OX Security](https://www.ox.security/blog/static-application-security-sast-tools/)
- [Top 10 DAST Tools 2025 - Terra Security](https://www.terra.security/blog/top-10-dast-dynamic-application-security-testing-tools-for-2025)

### RLS Testing

- [Supabase RLS Documentation](https://supabase.com/docs/guides/database/postgres/row-level-security)
- [Supashield - Automated Supabase RLS Testing](https://github.com/Rodrigotari1/supashield)
- [pgTAP Testing for RLS - Medium](https://blair-devmode.medium.com/testing-row-level-security-rls-policies-in-postgresql-with-pgtap-a-supabase-example-b435c1852602)
- [Supabase RLS Checker Chrome Extension](https://chromewebstore.google.com/detail/supabase-rls-checker/mklgkhbdilmbfjnnclabobnledggcada)

### Dependency Scanning

- [Comparing npm audit with Snyk - Nearform](https://www.nearform.com/blog/comparing-npm-audit-with-snyk/)
- [npm Security Guide - Cyberdesserts](https://blog.cyberdesserts.com/npm-security-vulnerabilities/)

### Supabase Security

- [Supabase SSL Enforcement](https://supabase.com/docs/guides/platform/ssl-enforcement)
- [Supabase Platform Security](https://supabase.com/docs/guides/security/platform-security)
- [Security at Supabase](https://supabase.com/security)
- [Best Security Practices in Supabase - Supadex](https://www.supadex.app/blog/best-security-practices-in-supabase-a-comprehensive-guide)

### GitHub Actions Security

- [Enterprise DevSecOps with GitHub Actions - SchreiberCyber](https://scyber.ai/blog/devsecops-github-actions/)
- [Semgrep GitHub Integration](https://semgrep.dev/blog/2021/protect-your-github-actions-with-semgrep/)
