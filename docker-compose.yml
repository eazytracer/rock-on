# Rock-On Development Stack
# ============================================================================
# Uses Supabase CLI (via init container) to manage database services.
# This ensures proper role creation, migrations, and seed data.
#
# Usage:
#   ./start-docker.sh                           # Start everything
#   HOST_IP=192.168.1.100 ./start-docker.sh     # Start for phone testing
#
# Or manually:
#   docker compose run --rm supabase-init       # Initialize Supabase
#   docker compose up rock-on-dev               # Start the app
# ============================================================================

version: '3.8'

services:
  # ===========================================================================
  # SUPABASE INITIALIZATION (one-time setup via CLI)
  # ===========================================================================
  supabase-init:
    image: node:22-alpine
    container_name: rock-on-supabase-init
    volumes:
      # Mount docker.sock to control host Docker
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount project directory
      - .:/app
    working_dir: /app
    environment:
      - HOST_IP=${HOST_IP:-localhost}
    command: >
      sh -c "
        echo '=============================================='
        echo 'Supabase Initialization'
        echo '=============================================='

        # Install dependencies for Supabase CLI
        apk add --no-cache curl docker-cli

        # Install Supabase CLI via direct binary download
        echo '[1/3] Installing Supabase CLI...'
        curl -sSL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar -xz -C /usr/local/bin

        # Check if Supabase is already running
        echo '[2/3] Checking Supabase status...'
        if supabase status 2>/dev/null | grep -q 'API URL'; then
          echo '  ✓ Supabase is already running'
        else
          echo '  Starting Supabase...'
          supabase start
          echo '  ✓ Supabase started'
        fi

        # Show status
        echo ''
        echo '[3/3] Supabase Status:'
        supabase status

        echo ''
        echo '=============================================='
        echo 'Initialization complete!'
        echo '=============================================='
      "
    profiles:
      - init

  # ===========================================================================
  # SUPABASE PROXY (exposes localhost-bound Supabase to external IPs)
  # ===========================================================================
  # Supabase CLI binds to 127.0.0.1, so we need a proxy for phone testing.
  # This nginx container forwards external requests to the local Supabase services.
  supabase-proxy:
    image: nginx:alpine
    container_name: rock-on-supabase-proxy
    restart: unless-stopped
    ports:
      - "54321:54321"   # Supabase API
      - "54323:54323"   # Supabase Studio
      - "54324:54324"   # Inbucket (email testing)
    volumes:
      - ./docker/nginx-proxy.conf:/etc/nginx/nginx.conf:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    profiles:
      - proxy

  # ===========================================================================
  # APPLICATION SERVICE
  # ===========================================================================
  rock-on-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: rock-on-dev
    restart: unless-stopped
    ports:
      - "5173:5173"
    volumes:
      - .:/app
      - node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - VITE_MOCK_AUTH=false
      # For phone testing, set HOST_IP to your machine's IP
      # host.docker.internal resolves to host on Docker Desktop (Win/Mac)
      - VITE_SUPABASE_URL=http://${HOST_IP:-host.docker.internal}:54321
      - VITE_SUPABASE_ANON_KEY=${ANON_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0}
      - VITE_GOOGLE_CLIENT_ID=${VITE_GOOGLE_CLIENT_ID:-mock}
    extra_hosts:
      # Allows container to reach host services on Windows/Mac Docker Desktop
      - "host.docker.internal:host-gateway"

  # ===========================================================================
  # PRODUCTION BUILD (optional)
  # ===========================================================================
  rock-on-prod:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: rock-on-prod
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - VITE_SUPABASE_URL=${VITE_SUPABASE_URL}
      - VITE_SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY}
      - VITE_GOOGLE_CLIENT_ID=${VITE_GOOGLE_CLIENT_ID}
    profiles:
      - prod

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  node_modules:
    driver: local
